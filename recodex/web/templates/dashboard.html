<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 0;
            margin-bottom: 30px;
            border-radius: 8px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .status-indicator {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
        }
        
        .status-running {
            background-color: #28a745;
            color: white;
        }
        
        .status-stopped {
            background-color: #dc3545;
            color: white;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
            transition: transform 0.2s;
        }
        
        .card:hover {
            transform: translateY(-2px);
        }
        
        .card h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .stat-item:last-child {
            border-bottom: none;
        }
        
        .stat-label {
            font-weight: 500;
        }
        
        .stat-value {
            font-weight: bold;
            color: #667eea;
        }
        
        .worker-item {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 10px;
        }
        
        .worker-item:last-child {
            margin-bottom: 0;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background-color: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 5px;
        }
        
        .progress-fill {
            height: 100%;
            background-color: #28a745;
            transition: width 0.3s ease;
        }
        
        .loading {
            text-align: center;
            color: #666;
            font-style: italic;
        }
        
        .profile-item {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 10px;
        }
        
        .profile-item:last-child {
            margin-bottom: 0;
        }
        
        .refresh-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.2s;
        }
        
        .refresh-btn:hover {
            background: #5a67d8;
        }
        
        .auto-refresh {
            text-align: center;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>RecodeX Dashboard</h1>
            <div id="service-status" class="status-indicator">
                <span class="loading">Loading...</span>
            </div>
        </div>
        
        <div class="grid">
            <!-- Service Status Card -->
            <div class="card">
                <h2>Service Status</h2>
                <div id="status-content" class="loading">Loading status...</div>
            </div>
            
            <!-- Statistics Card -->
            <div class="card">
                <h2>Processing Statistics</h2>
                <div id="statistics-content" class="loading">Loading statistics...</div>
            </div>
            
            <!-- Workers Card -->
            <div class="card">
                <h2>Workers</h2>
                <div id="workers-content" class="loading">Loading workers...</div>
            </div>
            
            <!-- Watch Folders Card -->
            <div class="card">
                <h2>Watch Folders</h2>
                <div id="watch-folders-content" class="loading">Loading configuration...</div>
            </div>
            
            <!-- Profiles Card -->
            <div class="card">
                <h2>Encoding Profiles</h2>
                <div id="profiles-content" class="loading">Loading profiles...</div>
            </div>
            
            <!-- Queue Status Card -->
            <div class="card">
                <h2>Queue Status</h2>
                <div id="queue-content" class="loading">Loading queue...</div>
            </div>
        </div>
        
        <div class="auto-refresh">
            <button class="refresh-btn" onclick="refreshData()">Refresh Now</button>
            <p>Auto-refreshing every 5 seconds</p>
        </div>
    </div>

    <script>
        async function fetchData(endpoint) {
            try {
                const response = await fetch(endpoint);
                return await response.json();
            } catch (error) {
                console.error('Error fetching data:', error);
                return null;
            }
        }
        
        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        function formatDuration(seconds) {
            if (!seconds) return '0s';
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);
            
            if (hours > 0) {
                return `${hours}h ${minutes}m ${secs}s`;
            } else if (minutes > 0) {
                return `${minutes}m ${secs}s`;
            } else {
                return `${secs}s`;
            }
        }
        
        function updateServiceStatus(status) {
            const indicator = document.getElementById('service-status');
            if (status && status.service_running) {
                indicator.className = 'status-indicator status-running';
                indicator.innerHTML = '● Service Running';
            } else {
                indicator.className = 'status-indicator status-stopped';
                indicator.innerHTML = '● Service Stopped';
            }
        }
        
        function updateStatus(status) {
            const content = document.getElementById('status-content');
            if (!status) {
                content.innerHTML = '<div class="loading">Failed to load status</div>';
                return;
            }
            
            const html = `
                <div class="stat-item">
                    <span class="stat-label">Service</span>
                    <span class="stat-value">${status.service_running ? 'Running' : 'Stopped'}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">File Monitor</span>
                    <span class="stat-value">${status.file_monitor?.running ? 'Active' : 'Inactive'}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Watch Folders</span>
                    <span class="stat-value">${status.file_monitor?.watch_folders || 0}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Queue Size</span>
                    <span class="stat-value">${status.file_monitor?.queue_size || 0}</span>
                </div>
            `;
            content.innerHTML = html;
        }
        
        function updateStatistics(stats) {
            const content = document.getElementById('statistics-content');
            if (!stats) {
                content.innerHTML = '<div class="loading">Failed to load statistics</div>';
                return;
            }
            
            const html = `
                <div class="stat-item">
                    <span class="stat-label">Total Processed</span>
                    <span class="stat-value">${stats.total_processed || 0}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Space Saved</span>
                    <span class="stat-value">${formatBytes(stats.total_space_saved || 0)}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Original Size</span>
                    <span class="stat-value">${formatBytes(stats.total_original_size || 0)}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Avg Compression</span>
                    <span class="stat-value">${(stats.average_compression_ratio || 0).toFixed(2)}x</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Avg Processing Time</span>
                    <span class="stat-value">${formatDuration(stats.average_processing_time || 0)}</span>
                </div>
            `;
            content.innerHTML = html;
        }
        
        function updateWorkers(status) {
            const content = document.getElementById('workers-content');
            if (!status || !status.workers) {
                content.innerHTML = '<div class="loading">Failed to load workers</div>';
                return;
            }
            
            const workers = status.workers.workers || [];
            if (workers.length === 0) {
                content.innerHTML = '<div>No workers running</div>';
                return;
            }
            
            const html = workers.map(worker => `
                <div class="worker-item">
                    <strong>Worker ${worker.worker_id}</strong>
                    <div>Status: ${worker.running ? 'Running' : 'Stopped'}</div>
                    <div>Job: ${worker.current_job?.status || 'idle'}</div>
                    ${worker.current_job?.input_path ? `<div>File: ${worker.current_job.input_path}</div>` : ''}
                    ${worker.current_job?.progress > 0 ? `
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${worker.current_job.progress}%"></div>
                        </div>
                        <div>Progress: ${worker.current_job.progress.toFixed(1)}%</div>
                    ` : ''}
                </div>
            `).join('');
            
            content.innerHTML = html;
        }
        
        function updateWatchFolders(config) {
            const content = document.getElementById('watch-folders-content');
            if (!config || !config.watch_folders) {
                content.innerHTML = '<div class="loading">Failed to load configuration</div>';
                return;
            }
            
            const folders = config.watch_folders;
            if (folders.length === 0) {
                content.innerHTML = '<div>No watch folders configured</div>';
                return;
            }
            
            const html = folders.map(folder => `
                <div class="profile-item">
                    <strong>${folder.path}</strong>
                    <div>Profile: ${folder.profile}</div>
                    <div>Recursive: ${folder.recursive ? 'Yes' : 'No'}</div>
                    <div>Extensions: ${folder.extensions.join(', ')}</div>
                    ${folder.output_path ? `<div>Output: ${folder.output_path}</div>` : ''}
                </div>
            `).join('');
            
            content.innerHTML = html;
        }
        
        function updateProfiles(config) {
            const content = document.getElementById('profiles-content');
            if (!config || !config.profiles) {
                content.innerHTML = '<div class="loading">Failed to load configuration</div>';
                return;
            }
            
            const profiles = Object.entries(config.profiles);
            if (profiles.length === 0) {
                content.innerHTML = '<div>No profiles configured</div>';
                return;
            }
            
            const html = profiles.map(([key, profile]) => `
                <div class="profile-item">
                    <strong>${profile.name}</strong>
                    <div>Video: ${profile.video_codec} (CRF: ${profile.video_crf})</div>
                    <div>Audio: ${profile.audio_codec}${profile.audio_bitrate ? ` (${profile.audio_bitrate})` : ''}</div>
                    <div>Container: ${profile.container}</div>
                    <div>Preset: ${profile.preset}</div>
                </div>
            `).join('');
            
            content.innerHTML = html;
        }
        
        function updateQueue(stats) {
            const content = document.getElementById('queue-content');
            if (!stats || !stats.queue_status) {
                content.innerHTML = '<div class="loading">Failed to load queue status</div>';
                return;
            }
            
            const queue = stats.queue_status;
            const html = `
                <div class="stat-item">
                    <span class="stat-label">Pending</span>
                    <span class="stat-value">${queue.pending || 0}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Running</span>
                    <span class="stat-value">${queue.running || 0}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Failed</span>
                    <span class="stat-value">${queue.failed || 0}</span>
                </div>
            `;
            content.innerHTML = html;
        }
        
        async function refreshData() {
            console.log('Refreshing dashboard data...');
            
            // Fetch all data
            const [status, statistics, config] = await Promise.all([
                fetchData('/api/status'),
                fetchData('/api/statistics'),
                fetchData('/api/config')
            ]);
            
            // Update all sections
            updateServiceStatus(status);
            updateStatus(status);
            updateStatistics(statistics);
            updateWorkers(status);
            updateWatchFolders(config);
            updateProfiles(config);
            updateQueue(statistics);
        }
        
        // Initial load
        refreshData();
        
        // Auto-refresh every 5 seconds
        setInterval(refreshData, 5000);
    </script>
</body>
</html>